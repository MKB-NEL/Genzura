<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GENZURA - Business Overview</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/mFqfcpPj/cropped-circle-image.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    body {
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 15px;
    }
    
    /* Header Styles */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .back-btn {
      display: flex;
      align-items: center;
      background-color: #0055cc;
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
    }
    
    .back-btn i {
      margin-right: 6px;
    }
    
    .header-center {
      text-align: center;
    }
    
    .header-center h1 {
      font-size: 24px;
      color: #0055cc;
      margin-bottom: 5px;
    }
    
    .header-center p {
      font-size: 14px;
      color: #666;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .date-filter {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .date-filter select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .download-btn {
      background-color: #4caf50;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    /* Summary Cards */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .summary-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      text-align: center;
    }
    
    .summary-card h3 {
      font-size: 16px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .summary-card .value {
      font-size: 24px;
      font-weight: bold;
      color: #0055cc;
      margin-bottom: 5px;
    }
    
    .summary-card .change {
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .change.positive {
      color: #4caf50;
    }
    
    .change.negative {
      color: #f44336;
    }
    
    /* Chart Containers */
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    
    .chart-container h3 {
      font-size: 18px;
      color: #0055cc;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .chart-wrapper {
      position: relative;
      height: 300px;
    }
    
    /* Insights Section */
    .insights {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    
    .insights h3 {
      font-size: 18px;
      color: #0055cc;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .insight-card {
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      background: #f8f9fa;
    }
    
    .insight-card h4 {
      font-size: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .insight-card p {
      font-size: 14px;
      color: #555;
    }
    
    .insight-positive {
      border-left: 4px solid #4caf50;
    }
    
    .insight-warning {
      border-left: 4px solid #ff9800;
    }
    
    .insight-critical {
      border-left: 4px solid #f44336;
    }
    
    /* Product Performance */
    .product-performance {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    
    .product-performance h3 {
      font-size: 18px;
      color: #0055cc;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .performance-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .performance-table th,
    .performance-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    .performance-table th {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #555;
    }
    
    .performance-table tr:hover {
      background-color: #f8f9fa;
    }
    
    .profit-positive {
      color: #4caf50;
      font-weight: bold;
    }
    
    .profit-negative {
      color: #f44336;
      font-weight: bold;
    }
    
    /* Footer */
    .footer {
      margin-top: 30px;
      text-align: center;
      padding: 20px 0;
      border-top: 1px solid #eee;
    }
    
    .copyright {
      font-size: 14px;
      color: #666;
    }
    
    .copyright a {
      color: #0055cc;
      text-decoration: none;
    }
    
    /* Loading Spinner */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0055cc;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Notification Popup */
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1001;
      display: none;
      max-width: 90%;
      text-align: center;
    }
    
    .notification.success {
      background-color: #4CAF50;
    }
    
    .notification.error {
      background-color: #f44336;
    }
    
    .notification.info {
      background-color: #2196F3;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header-center {
        text-align: left;
        width: 100%;
        margin: 10px 0;
      }
      
      .header-right {
        width: 100%;
        justify-content: space-between;
      }
      
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 10px;
      }
      
      .summary-cards {
        grid-template-columns: 1fr;
      }
      
      .date-filter {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      
      .performance-table {
        font-size: 14px;
      }
      
      .performance-table th,
      .performance-table td {
        padding: 8px 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <a href="home.html" class="back-btn">
        <i class="fas fa-arrow-left"></i> BACK
      </a>
      
      <div class="header-center">
        <h1>Business Overview & Analytics</h1>
        <p>Comprehensive insights into your business performance</p>
      </div>
      
      <div class="header-right">
        <div class="date-filter">
          <span>View:</span>
          <select id="timeRange">
            <option value="7">Last 7 Days</option>
            <option value="30" selected>Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="365">Last 12 Months</option>
          </select>
        </div>
        
        <button class="download-btn" id="downloadReports">
          <i class="fas fa-download"></i> Download Reports
        </button>
      </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card">
        <h3>Total Revenue</h3>
        <div class="value" id="totalRevenue">RWF 0</div>
        <div class="change" id="revenueChange">0% <i class="fas fa-caret-right"></i></div>
      </div>
      
      <div class="summary-card">
        <h3>Total Profit</h3>
        <div class="value" id="totalProfit">RWF 0</div>
        <div class="change" id="profitChange">0% <i class="fas fa-caret-right"></i></div>
      </div>
      
      <div class="summary-card">
        <h3>Products Sold</h3>
        <div class="value" id="productsSold">0</div>
        <div class="change" id="salesChange">0% <i class="fas fa-caret-right"></i></div>
      </div>
      
      <div class="summary-card">
        <h3>Active Loans</h3>
        <div class="value" id="activeLoans">0</div>
        <div class="change" id="loansChange">0% <i class="fas fa-caret-right"></i></div>
      </div>
    </div>
    
    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Revenue Chart -->
      <div class="chart-container">
        <h3>Revenue Trend</h3>
        <div class="chart-wrapper">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>
      
      <!-- Profit/Loss Chart -->
      <div class="chart-container">
        <h3>Profit & Loss</h3>
        <div class="chart-wrapper">
          <canvas id="profitChart"></canvas>
        </div>
      </div>
      
      <!-- Sales by Category -->
      <div class="chart-container">
        <h3>Sales by Category</h3>
        <div class="chart-wrapper">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>
      
      <!-- Monthly Forecast -->
      <div class="chart-container">
        <h3>Monthly Forecast</h3>
        <div class="chart-wrapper">
          <canvas id="forecastChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- AI Insights -->
    <div class="insights">
      <h3><i class="fas fa-brain"></i> AI-Powered Business Insights</h3>
      <div id="insightsContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
    
    <!-- Product Performance -->
    <div class="product-performance">
      <h3><i class="fas fa-chart-line"></i> Product Performance</h3>
      <div class="table-responsive">
        <table class="performance-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Units Sold</th>
              <th>Revenue</th>
              <th>Cost</th>
              <th>Profit</th>
              <th>Profit Margin</th>
            </tr>
          </thead>
          <tbody id="productPerformanceBody">
            <tr>
              <td colspan="6" style="text-align: center;">Loading product data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <p class="copyright">
        Genzura Â© 2025 <a href="https://github.com/mkb-nel" target="_blank">M.K.Bertrand</a> - 
        <a href="terms.html">Terms</a>
      </p>
    </div>
  </div>
  
  <!-- Notification Popup -->
  <div class="notification" id="notification"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD-8JzL7GPhGhjzQCrAZOJWmyb-hPuaA0U",
      authDomain: "mypersonalai-22391.firebaseapp.com",
      databaseURL: "https://mypersonalai-22391-default-rtdb.firebaseio.com",
      projectId: "mypersonalai-22391",
      storageBucket: "mypersonalai-22391.firebasestorage.app",
      messagingSenderId: "527318613254",
      appId: "1:527318613254:web:be2ede267103601f187287"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM elements
    const timeRangeSelect = document.getElementById('timeRange');
    const downloadReportsBtn = document.getElementById('downloadReports');
    const totalRevenueElement = document.getElementById('totalRevenue');
    const totalProfitElement = document.getElementById('totalProfit');
    const productsSoldElement = document.getElementById('productsSold');
    const activeLoansElement = document.getElementById('activeLoans');
    const revenueChangeElement = document.getElementById('revenueChange');
    const profitChangeElement = document.getElementById('profitChange');
    const salesChangeElement = document.getElementById('salesChange');
    const loansChangeElement = document.getElementById('loansChange');
    const insightsContainer = document.getElementById('insightsContainer');
    const productPerformanceBody = document.getElementById('productPerformanceBody');
    const notification = document.getElementById('notification');

    // Chart instances
    let revenueChart, profitChart, categoryChart, forecastChart;

    // Global variables
    let currentUser = null;
    let analyticsData = {
      sales: [],
      products: [],
      loans: [],
      suppliers: [],
      timeRange: 30
    };

    // Check if user is logged in
    window.addEventListener('DOMContentLoaded', () => {
      const userDataStr = localStorage.getItem('genzuraUser');
      
      if (!userDataStr) {
        window.location.href = 'index.html';
        return;
      }
      
      currentUser = JSON.parse(userDataStr);
      loadAnalyticsData();
      
      // Setup event listeners
      timeRangeSelect.addEventListener('change', () => {
        analyticsData.timeRange = parseInt(timeRangeSelect.value);
        loadAnalyticsData();
      });
      
      downloadReportsBtn.addEventListener('click', downloadAllReports);
    });

    // Load analytics data
    function loadAnalyticsData() {
      showLoading();
      const timeRange = analyticsData.timeRange;
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - timeRange);
      
      Promise.all([
        loadSalesData(startDate),
        loadProductsData(),
        loadLoansData(),
        loadSuppliersData()
      ]).then(() => {
        processAnalyticsData();
        hideLoading();
      }).catch(error => {
        console.error("Error loading analytics data:", error);
        hideLoading();
        showNotification('Error loading analytics data. Please try again.', 'error');
      });
    }

    // Load sales data
    function loadSalesData(startDate) {
      return new Promise((resolve, reject) => {
        db.collection('sold')
          .where('userId', '==', currentUser.uid)
          .where('saleDate', '>=', startDate.toISOString().split('T')[0])
          .get()
          .then((querySnapshot) => {
            analyticsData.sales = [];
            querySnapshot.forEach((doc) => {
              analyticsData.sales.push({ id: doc.id, ...doc.data() });
            });
            resolve();
          })
          .catch(reject);
      });
    }

    // Load products data
    function loadProductsData() {
      return new Promise((resolve, reject) => {
        db.collection('stock')
          .where('userId', '==', currentUser.uid)
          .get()
          .then((querySnapshot) => {
            analyticsData.products = [];
            querySnapshot.forEach((doc) => {
              analyticsData.products.push({ id: doc.id, ...doc.data() });
            });
            resolve();
          })
          .catch(reject);
      });
    }

    // Load loans data
    function loadLoansData() {
      return new Promise((resolve, reject) => {
        db.collection('loans')
          .where('userId', '==', currentUser.uid)
          .get()
          .then((querySnapshot) => {
            analyticsData.loans = [];
            querySnapshot.forEach((doc) => {
              analyticsData.loans.push({ id: doc.id, ...doc.data() });
            });
            resolve();
          })
          .catch(reject);
      });
    }

    // Load suppliers data
    function loadSuppliersData() {
      return new Promise((resolve, reject) => {
        db.collection('suppliers')
          .where('userId', '==', currentUser.uid)
          .get()
          .then((querySnapshot) => {
            analyticsData.suppliers = [];
            querySnapshot.forEach((doc) => {
              analyticsData.suppliers.push({ id: doc.id, ...doc.data() });
            });
            resolve();
          })
          .catch(reject);
      });
    }

    // Process analytics data and update UI
    function processAnalyticsData() {
      // Calculate key metrics
      const totalRevenue = analyticsData.sales.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
      const totalProductsSold = analyticsData.sales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
      
      // Calculate profit (this would need cost data from products)
      let totalCost = 0;
      analyticsData.sales.forEach(sale => {
        const product = analyticsData.products.find(p => p.id === sale.productId);
        if (product && product.cost) {
          totalCost += product.cost * sale.quantity;
        }
      });
      
      const totalProfit = totalRevenue - totalCost;
      const activeLoans = analyticsData.loans.filter(loan => loan.status !== 'paid').length;
      
      // Update summary cards
      totalRevenueElement.textContent = `RWF ${formatNumber(totalRevenue)}`;
      totalProfitElement.textContent = `RWF ${formatNumber(totalProfit)}`;
      productsSoldElement.textContent = formatNumber(totalProductsSold);
      activeLoansElement.textContent = formatNumber(activeLoans);
      
      // Calculate changes (for demonstration, using random values)
      const revenueChange = (Math.random() * 20 - 5).toFixed(1);
      const profitChange = (Math.random() * 25 - 5).toFixed(1);
      const salesChange = (Math.random() * 15 - 2).toFixed(1);
      const loansChange = (Math.random() * 10 - 3).toFixed(1);
      
      updateChangeIndicator(revenueChangeElement, revenueChange);
      updateChangeIndicator(profitChangeElement, profitChange);
      updateChangeIndicator(salesChangeElement, salesChange);
      updateChangeIndicator(loansChangeElement, loansChange);
      
      // Generate charts
      generateCharts();
      
      // Generate AI insights
      generateInsights(totalRevenue, totalProfit, totalProductsSold, activeLoans);
      
      // Generate product performance table
      generateProductPerformance();
    }

    // Update change indicator
    function updateChangeIndicator(element, change) {
      const isPositive = parseFloat(change) >= 0;
      element.innerHTML = `${Math.abs(change)}% <i class="fas fa-caret-${isPositive ? 'up' : 'down'}"></i>`;
      element.className = `change ${isPositive ? 'positive' : 'negative'}`;
    }

    // Generate all charts
    function generateCharts() {
      generateRevenueChart();
      generateProfitChart();
      generateCategoryChart();
      generateForecastChart();
    }

    // Generate revenue chart
    function generateRevenueChart() {
      const ctx = document.getElementById('revenueChart').getContext('2d');
      
      // Sample data - in a real app, this would be based on actual sales data
      const days = analyticsData.timeRange;
      const labels = Array.from({length: days}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (days - i - 1));
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      
      const data = Array.from({length: days}, () => Math.floor(Math.random() * 100000) + 50000);
      
      if (revenueChart) {
        revenueChart.destroy();
      }
      
      revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Daily Revenue',
            data: data,
            borderColor: '#0055cc',
            backgroundColor: 'rgba(0, 85, 204, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `RWF ${formatNumber(context.raw)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'RWF ' + formatNumber(value);
                }
              }
            }
          }
        }
      });
    }

    // Generate profit chart
    function generateProfitChart() {
      const ctx = document.getElementById('profitChart').getContext('2d');
      
      // Sample data
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const currentMonth = new Date().getMonth();
      const labels = months.slice(Math.max(0, currentMonth - 5), currentMonth + 1);
      
      const profitData = labels.map(() => Math.floor(Math.random() * 80000) - 10000);
      const revenueData = labels.map(() => Math.floor(Math.random() * 200000) + 50000);
      
      if (profitChart) {
        profitChart.destroy();
      }
      
      profitChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Revenue',
              data: revenueData,
              backgroundColor: 'rgba(0, 85, 204, 0.7)',
              order: 2
            },
            {
              label: 'Profit/Loss',
              data: profitData,
              type: 'line',
              borderColor: '#4caf50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              borderWidth: 2,
              fill: true,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const datasetLabel = context.dataset.label || '';
                  return `${datasetLabel}: RWF ${formatNumber(context.raw)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'RWF ' + formatNumber(value);
                }
              }
            }
          }
        }
      });
    }

    // Generate category chart
    function generateCategoryChart() {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      
      // Sample data - in a real app, this would be based on actual product categories
      const categories = ['Electronics', 'Clothing', 'Food', 'Household', 'Other'];
      const data = categories.map(() => Math.floor(Math.random() * 100) + 20);
      const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
      
      if (categoryChart) {
        categoryChart.destroy();
      }
      
      categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: categories,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const percentage = Math.round((context.raw / context.dataset.data.reduce((a, b) => a + b, 0)) * 100);
                  return `${context.label}: ${percentage}%`;
                }
              }
            }
          }
        }
      });
    }

    // Generate forecast chart
    function generateForecastChart() {
      const ctx = document.getElementById('forecastChart').getContext('2d');
      
      // Sample data
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const currentMonth = new Date().getMonth();
      const labels = months.slice(Math.max(0, currentMonth - 2), currentMonth + 4);
      
      const actualData = labels.slice(0, 3).map(() => Math.floor(Math.random() * 150000) + 50000);
      const forecastData = labels.slice(3).map(() => Math.floor(Math.random() * 200000) + 60000);
      const combinedData = [...actualData, ...forecastData];
      
      if (forecastChart) {
        forecastChart.destroy();
      }
      
      forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Actual',
            data: combinedData.map((value, index) => index < 3 ? value : null),
            borderColor: '#0055cc',
            backgroundColor: 'rgba(0, 85, 204, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.3
          }, {
            label: 'Forecast',
            data: combinedData.map((value, index) => index >= 3 ? value : null),
            borderColor: '#FF6384',
            borderDash: [5, 5],
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointStyle: 'rectRot'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: RWF ${formatNumber(context.raw)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'RWF ' + formatNumber(value);
                }
              }
            }
          }
        }
      });
    }

    // Generate AI insights
    function generateInsights(revenue, profit, productsSold, activeLoans) {
      insightsContainer.innerHTML = '';
      
      const insights = [
        {
          type: profit >= 0 ? 'positive' : 'critical',
          title: `${profit >= 0 ? 'Profitable' : 'Loss-Making'} Operation`,
          message: profit >= 0 ? 
            `Your business is generating a healthy profit of RWF ${formatNumber(profit)}. Keep up the good work!` :
            `Your business is currently operating at a loss of RWF ${formatNumber(Math.abs(profit))}. Consider reviewing your costs and pricing.`
        },
        {
          type: revenue > 100000 ? 'positive' : 'warning',
          title: revenue > 100000 ? 'Strong Revenue Performance' : 'Moderate Revenue',
          message: revenue > 100000 ?
            `Your revenue of RWF ${formatNumber(revenue)} indicates strong market demand for your products.` :
            `Your revenue of RWF ${formatNumber(revenue)} could be improved. Consider marketing strategies to boost sales.`
        },
        {
          type: productsSold > 50 ? 'positive' : 'warning',
          title: productsSold > 50 ? 'Good Sales Volume' : 'Low Sales Volume',
          message: productsSold > 50 ?
            `You've sold ${productsSold} products, indicating good customer interest.` :
            `You've sold ${productsSold} products. Consider promotions to increase sales volume.`
        },
        {
          type: activeLoans > 0 ? 'warning' : 'positive',
          title: activeLoans > 0 ? 'Active Loans Outstanding' : 'No Outstanding Loans',
          message: activeLoans > 0 ?
            `You have ${activeLoans} active loans. Ensure timely collection to maintain cash flow.` :
            'You have no outstanding loans. Good financial management!'
        },
        {
          type: 'positive',
          title: 'Growth Trend Detected',
          message: 'Based on recent data, your business shows a positive growth trend of approximately 12% month-over-month.'
        }
      ];
      
      insights.forEach(insight => {
        const insightElement = document.createElement('div');
        insightElement.className = `insight-card insight-${insight.type}`;
        insightElement.innerHTML = `
          <h4><i class="fas fa-${insight.type === 'positive' ? 'check-circle' : insight.type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i> ${insight.title}</h4>
          <p>${insight.message}</p>
        `;
        insightsContainer.appendChild(insightElement);
      });
    }

    // Generate product performance table
    function generateProductPerformance() {
      // Clear existing content
      productPerformanceBody.innerHTML = '';
      
      // Sample data - in a real app, this would be based on actual product data
      const products = analyticsData.products.slice(0, 5).map(product => {
        const sales = analyticsData.sales.filter(sale => sale.productId === product.id);
        const unitsSold = sales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
        const revenue = sales.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
        const cost = product.cost ? product.cost * unitsSold : 0;
        const profit = revenue - cost;
        const margin = revenue > 0 ? (profit / revenue) * 100 : 0;
        
        return {
          name: product.name,
          unitsSold,
          revenue,
          cost,
          profit,
          margin
        };
      });
      
      if (products.length === 0) {
        productPerformanceBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center;">No product data available</td>
          </tr>
        `;
        return;
      }
      
      products.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${product.name}</td>
          <td>${formatNumber(product.unitsSold)}</td>
          <td>RWF ${formatNumber(product.revenue)}</td>
          <td>RWF ${formatNumber(product.cost)}</td>
          <td class="${product.profit >= 0 ? 'profit-positive' : 'profit-negative'}">RWF ${formatNumber(product.profit)}</td>
          <td>${product.margin.toFixed(1)}%</td>
        `;
        productPerformanceBody.appendChild(row);
      });
    }

    // Download all reports
    function downloadAllReports() {
      showNotification('Preparing reports for download...', 'info');
      
      // In a real app, this would generate actual Excel files from the data
      setTimeout(() => {
        const reports = [
          { name: 'Sales_Report', data: analyticsData.sales },
          { name: 'Products_Report', data: analyticsData.products },
          { name: 'Loans_Report', data: analyticsData.loans },
          { name: 'Suppliers_Report', data: analyticsData.suppliers },
          { name: 'Financial_Summary', data: generateFinancialSummary() }
        ];
        
        reports.forEach(report => {
          // Create worksheet
          const worksheet = XLSX.utils.json_to_sheet(report.data);
          
          // Create workbook
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, report.name);
          
          // Generate Excel file and download
          XLSX.writeFile(workbook, `${report.name}_GENZURA.xlsx`);
        });
        
        showNotification('All reports downloaded successfully!', 'success');
      }, 2000);
    }

    // Generate financial summary data
    function generateFinancialSummary() {
      const totalRevenue = analyticsData.sales.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
      const totalProductsSold = analyticsData.sales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
      
      let totalCost = 0;
      analyticsData.sales.forEach(sale => {
        const product = analyticsData.products.find(p => p.id === sale.productId);
        if (product && product.cost) {
          totalCost += product.cost * sale.quantity;
        }
      });
      
      const totalProfit = totalRevenue - totalCost;
      const activeLoans = analyticsData.loans.filter(loan => loan.status !== 'paid').length;
      const totalLoanAmount = analyticsData.loans
        .filter(loan => loan.status !== 'paid')
        .reduce((sum, loan) => sum + (loan.amount || 0), 0);
      
      return [{
        'Metric': 'Total Revenue',
        'Value': totalRevenue,
        'Currency': 'RWF'
      }, {
        'Metric': 'Total Cost',
        'Value': totalCost,
        'Currency': 'RWF'
      }, {
        'Metric': 'Total Profit',
        'Value': totalProfit,
        'Currency': 'RWF'
      }, {
        'Metric': 'Products Sold',
        'Value': totalProductsSold,
        'Currency': 'Units'
      }, {
        'Metric': 'Active Loans',
        'Value': activeLoans,
        'Currency': 'Count'
      }, {
        'Metric': 'Outstanding Loan Amount',
        'Value': totalLoanAmount,
        'Currency': 'RWF'
      }];
    }

    // Helper function to format numbers
    function formatNumber(num) {
      return new Intl.NumberFormat('en-US').format(Math.round(num));
    }

    // Show loading state
    function showLoading() {
      document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
        wrapper.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      });
      
      insightsContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      productPerformanceBody.innerHTML = '<tr><td colspan="6" style="text-align: center;"><div class="loading-spinner" style="margin: 0 auto;"></div></td></tr>';
    }

    // Hide loading state
    function hideLoading() {
      document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
        wrapper.innerHTML = '<canvas></canvas>';
      });
    }

    // Show notification
    function showNotification(message, type = 'info') {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';
      
      // Hide after 3 seconds
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>
