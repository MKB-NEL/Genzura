<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GENZURA - Business Overview</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/mFqfcpPj/cropped-circle-image.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    body {
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 15px;
    }
    
    /* Header Styles */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .back-btn {
      display: flex;
      align-items: center;
      background-color: #0055cc;
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
    }
    
    .back-btn i {
      margin-right: 6px;
    }
    
    .business-header {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .business-logo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #f0f0f0;
      overflow: hidden;
      border: 2px solid #0055cc;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .business-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    
    .business-logo i {
      font-size: 20px;
      color: #0055cc;
    }
    
    .business-info h1 {
      font-size: 24px;
      color: #0055cc;
      margin-bottom: 5px;
    }
    
    .business-info p {
      font-size: 14px;
      color: #666;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .date-filter {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .date-filter select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .download-btn {
      background-color: #4caf50;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    /* Month Initialization */
    .month-init {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      text-align: center;
      margin-bottom: 25px;
    }
    
    .month-init h2 {
      font-size: 24px;
      color: #0055cc;
      margin-bottom: 15px;
    }
    
    .month-init p {
      font-size: 16px;
      color: #666;
      margin-bottom: 25px;
    }
    
    .start-month-btn {
      background-color: #0055cc;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }
    
    .init-progress {
      margin-top: 20px;
      display: none;
    }
    
    .progress-bar {
      height: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    
    .progress-fill {
      height: 100%;
      background-color: #0055cc;
      width: 0%;
      transition: width 0.5s ease;
    }
    
    .progress-text {
      font-size: 14px;
      color: #666;
    }
    
    /* Summary Cards */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .summary-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      text-align: center;
    }
    
    .summary-card h3 {
      font-size: 16px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .summary-card .value {
      font-size: 24px;
      font-weight: bold;
      color: #0055cc;
      margin-bottom: 5px;
    }
    
    .summary-card .change {
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .change.positive {
      color: #4caf50;
    }
    
    .change.negative {
      color: #f44336;
    }
    
    /* Split Boxes */
    .split-boxes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .split-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .split-box h3 {
      font-size: 18px;
      color: #0055cc;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .split-content {
      display: flex;
      justify-content: space-between;
    }
    
    .split-item {
      text-align: center;
      flex: 1;
    }
    
    .split-item .value {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .split-item .label {
      font-size: 14px;
      color: #666;
    }
    
    /* Chart Containers */
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      overflow-x: auto;
    }
    
    .chart-container h3 {
      font-size: 18px;
      color: #0055cc;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .chart-wrapper {
      position: relative;
      height: 300px;
      min-width: 800px;
    }
    
    /* Chart Navigation */
    .chart-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      padding: 0 10px;
    }
    
    .nav-btn {
      background-color: #0055cc;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .nav-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    /* Insights Section */
    .insights {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    
    .insights h3 {
      font-size: 18px;
      color: #0055cc;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .insight-card {
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      background: #f8f9fa;
    }
    
    .insight-card h4 {
      font-size: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .insight-card p {
      font-size: 14px;
      color: #555;
    }
    
    .insight-positive {
      border-left: 4px solid #4caf50;
    }
    
    .insight-warning {
      border-left: 4px solid #ff9800;
    }
    
    .insight-critical {
      border-left: 4px solid #f44336;
    }
    
    /* Product Performance */
    .product-performance {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    
    .product-performance h3 {
      font-size: 18px;
      color: #0055cc;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .performance-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .performance-table th,
    .performance-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    .performance-table th {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #555;
    }
    
    .performance-table tr:hover {
      background-color: #f8f9fa;
    }
    
    .profit-positive {
      color: #4caf50;
      font-weight: bold;
    }
    
    .profit-negative {
      color: #f44336;
      font-weight: bold;
    }
    
    /* Footer */
    .footer {
      margin-top: 30px;
      text-align: center;
      padding: 20px 0;
      border-top: 1px solid #eee;
    }
    
    .copyright {
      font-size: 14px;
      color: #666;
    }
    
    .copyright a {
      color: #0055cc;
      text-decoration: none;
    }
    
    /* Loading Spinner */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0055cc;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Notification Popup */
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1001;
      display: none;
      max-width: 90%;
      text-align: center;
    }
    
    .notification.success {
      background-color: #4CAF50;
    }
    
    .notification.error {
      background-color: #f44336;
    }
    
    .notification.info {
      background-color: #2196F3;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .business-header {
        width: 100%;
        margin-bottom: 15px;
      }
      
      .header-right {
        width: 100%;
        justify-content: space-between;
      }
      
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .split-boxes {
        grid-template-columns: 1fr;
      }
      
      .chart-wrapper {
        min-width: 600px;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 10px;
      }
      
      .summary-cards {
        grid-template-columns: 1fr;
      }
      
      .date-filter {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      
      .performance-table {
        font-size: 14px;
      }
      
      .performance-table th,
      .performance-table td {
        padding: 8px 5px;
      }
      
      .chart-wrapper {
        min-width: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <a href="home.html" class="back-btn">
        <i class="fas fa-arrow-left"></i> BACK
      </a>
      
      <div class="business-header">
        <div class="business-logo" id="businessLogo">
          <i class="fas fa-store"></i>
          <img src="" alt="Business Logo">
        </div>
        <div class="business-info">
          <h1 id="businessName">Business Name</h1>
          <p id="currentMonth">Month: Loading...</p>
        </div>
      </div>
      
      <div class="header-right">
        <div class="date-filter">
          <span>View:</span>
          <select id="timeRange">
            <option value="7">Last 7 Days</option>
            <option value="30" selected>Last 30 Days</option>
          </select>
        </div>
        
        <button class="download-btn" id="downloadReports">
          <i class="fas fa-download"></i> Download Reports
        </button>
      </div>
    </div>
    
    <!-- Month Initialization (shown when no data exists) -->
    <div class="month-init" id="monthInit">
      <h2>Start Tracking Your Business</h2>
      <p>Initialize your monthly analytics to start tracking performance, revenue, and growth opportunities.</p>
      <button class="start-month-btn" id="startMonthBtn">Start the Month</button>
      
      <div class="init-progress" id="initProgress">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Checking business...</div>
      </div>
    </div>
    
    <!-- Dashboard Content (hidden initially) -->
    <div id="dashboardContent" style="display: none;">
      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="summary-card">
          <h3>Total Revenue</h3>
          <div class="value" id="totalRevenue">RWF 0</div>
          <div class="change" id="revenueChange">0% <i class="fas fa-caret-right"></i></div>
        </div>
        
        <div class="summary-card">
          <h3>Total Profit</h3>
          <div class="value" id="totalProfit">RWF 0</div>
          <div class="change" id="profitChange">0% <i class="fas fa-caret-right"></i></div>
        </div>
        
        <div class="summary-card">
          <h3>Total Loss</h3>
          <div class="value" id="totalLoss">RWF 0</div>
          <div class="change" id="lossChange">0% <i class="fas fa-caret-right"></i></div>
        </div>
      </div>
      
      <!-- Split Boxes -->
      <div class="split-boxes">
        <div class="split-box">
          <h3>Products</h3>
          <div class="split-content">
            <div class="split-item">
              <div class="value" id="soldProducts">0</div>
              <div class="label">Sold</div>
            </div>
            <div class="split-item">
              <div class="value" id="unsoldProducts">0</div>
              <div class="label">Unsold</div>
            </div>
          </div>
        </div>
        
        <div class="split-box">
          <h3>Loans</h3>
          <div class="split-content">
            <div class="split-item">
              <div class="value" id="activeLoans">0</div>
              <div class="label">Active</div>
            </div>
            <div class="split-item">
              <div class="value" id="paidLoans">0</div>
              <div class="label">Paid</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- General Revenue Chart -->
      <div class="chart-container">
        <h3>Daily Revenue & Loss</h3>
        <div class="chart-wrapper">
          <canvas id="revenueChart"></canvas>
        </div>
        <div class="chart-navigation">
          <button class="nav-btn" id="prevDatesBtn" disabled>
            <i class="fas fa-chevron-left"></i> Previous Dates
          </button>
          <span id="dateRangeDisplay">Showing dates</span>
          <button class="nav-btn" id="nextDatesBtn">
            Next Dates <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      
      <!-- AI Insights -->
      <div class="insights">
        <h3><i class="fas fa-brain"></i> AI-Powered Business Insights</h3>
        <div id="insightsContainer">
          <div class="insight-card insight-warning">
            <h4><i class="fas fa-exclamation-triangle"></i> Insufficient Data</h4>
            <p>We need more business data to generate meaningful insights. Continue using Genzura to track sales, products, and loans for personalized recommendations.</p>
          </div>
        </div>
      </div>
      
      <!-- Product Performance -->
      <div class="product-performance">
        <h3><i class="fas fa-chart-line"></i> Product Performance</h3>
        <div class="table-responsive">
          <table class="performance-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Units Sold</th>
                <th>Revenue</th>
                <th>Cost</th>
                <th>Profit</th>
                <th>Profit Margin</th>
              </tr>
            </thead>
            <tbody id="productPerformanceBody">
              <tr>
                <td colspan="6" style="text-align: center;">No product data available yet</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <p class="copyright">
        Genzura Â© 2025 <a href="https://github.com/mkb-nel" target="_blank">M.K.Bertrand</a> - 
        <a href="terms.html">Terms</a>
      </p>
    </div>
  </div>
  
  <!-- Notification Popup -->
  <div class="notification" id="notification"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD-8JzL7GPhGhjzQCrAZOJWmyb-hPuaA0U",
      authDomain: "mypersonalai-22391.firebaseapp.com",
      databaseURL: "https://mypersonalai-22391-default-rtdb.firebaseio.com",
      projectId: "mypersonalai-22391",
      storageBucket: "mypersonalai-22391.firebasestorage.app",
      messagingSenderId: "527318613254",
      appId: "1:527318613254:web:be2ede267103601f187287"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM elements
    const businessNameElement = document.getElementById('businessName');
    const businessLogoElement = document.getElementById('businessLogo');
    const currentMonthElement = document.getElementById('currentMonth');
    const timeRangeSelect = document.getElementById('timeRange');
    const downloadReportsBtn = document.getElementById('downloadReports');
    const monthInitSection = document.getElementById('monthInit');
    const startMonthBtn = document.getElementById('startMonthBtn');
    const initProgressSection = document.getElementById('initProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const dashboardContent = document.getElementById('dashboardContent');
    
    // Summary elements
    const totalRevenueElement = document.getElementById('totalRevenue');
    const totalProfitElement = document.getElementById('totalProfit');
    const totalLossElement = document.getElementById('totalLoss');
    const revenueChangeElement = document.getElementById('revenueChange');
    const profitChangeElement = document.getElementById('profitChange');
    const lossChangeElement = document.getElementById('lossChange');
    const soldProductsElement = document.getElementById('soldProducts');
    const unsoldProductsElement = document.getElementById('unsoldProducts');
    const activeLoansElement = document.getElementById('activeLoans');
    const paidLoansElement = document.getElementById('paidLoans');
    
    // Chart navigation elements
    const prevDatesBtn = document.getElementById('prevDatesBtn');
    const nextDatesBtn = document.getElementById('nextDatesBtn');
    const dateRangeDisplay = document.getElementById('dateRangeDisplay');
    
    // Other elements
    const insightsContainer = document.getElementById('insightsContainer');
    const productPerformanceBody = document.getElementById('productPerformanceBody');
    const notification = document.getElementById('notification');

    // Chart instances
    let revenueChart = null;

    // Global variables
    let currentUser = null;
    let businessData = null;
    let analyticsData = {
      sales: [],
      products: [],
      loans: [],
      timeRange: 30
    };
    let monthInitialized = false;
    let chartDataOffset = 0; // For tracking which dates we're showing

    // Check if user is logged in
    window.addEventListener('DOMContentLoaded', () => {
      const userDataStr = localStorage.getItem('genzuraUser');
      
      if (!userDataStr) {
        window.location.href = 'index.html';
        return;
      }
      
      currentUser = JSON.parse(userDataStr);
      loadBusinessData();
      
      // Setup event listeners
      timeRangeSelect.addEventListener('change', () => {
        analyticsData.timeRange = parseInt(timeRangeSelect.value);
        chartDataOffset = 0; // Reset to current dates
        if (monthInitialized) {
          loadAnalyticsData();
        }
      });
      
      downloadReportsBtn.addEventListener('click', downloadAllReports);
      startMonthBtn.addEventListener('click', initializeMonth);
      
      // Chart navigation event listeners
      prevDatesBtn.addEventListener('click', () => {
        chartDataOffset += analyticsData.timeRange;
        updateChartNavigation();
        generateRevenueChart();
      });
      
      nextDatesBtn.addEventListener('click', () => {
        chartDataOffset = Math.max(0, chartDataOffset - analyticsData.timeRange);
        updateChartNavigation();
        generateRevenueChart();
      });
    });

    // Load business data
    function loadBusinessData() {
      db.collection('users').doc(currentUser.uid).get()
        .then((doc) => {
          if (doc.exists) {
            businessData = doc.data();
            businessNameElement.textContent = businessData.businessName || "Business Name";
            
            // Load logo if available
            if (businessData.logoUrl) {
              const img = businessLogoElement.querySelector('img');
              const icon = businessLogoElement.querySelector('i');
              if (img) {
                img.src = businessData.logoUrl;
                img.style.display = 'block';
                icon.style.display = 'none';
              }
            }
            
            // Check if month is initialized
            checkMonthInitialization();
          } else {
            console.log("No user data found in Firestore");
            showNotification('Error loading business data', 'error');
          }
        })
        .catch((error) => {
          console.log("Error getting user data:", error);
          showNotification('Error loading business data', 'error');
        });
    }

    // Check if month is initialized
    function checkMonthInitialization() {
      const currentDate = new Date();
      const currentMonthYear = `${currentDate.getMonth() + 1}-${currentDate.getFullYear()}`;
      currentMonthElement.textContent = `Month: ${getMonthName(currentDate.getMonth())} ${currentDate.getFullYear()}`;
      
      db.collection('analytics')
        .where('userId', '==', currentUser.uid)
        .where('month', '==', currentMonthYear)
        .get()
        .then((querySnapshot) => {
          if (!querySnapshot.empty) {
            // Month is initialized, show dashboard
            monthInitialized = true;
            monthInitSection.style.display = 'none';
            dashboardContent.style.display = 'block';
            loadAnalyticsData();
          } else {
            // Month not initialized, show initialization section
            monthInitialized = false;
            monthInitSection.style.display = 'block';
            dashboardContent.style.display = 'none';
          }
        })
        .catch((error) => {
          console.log("Error checking month initialization:", error);
          monthInitSection.style.display = 'block';
          dashboardContent.style.display = 'none';
        });
    }

    // Initialize month
    function initializeMonth() {
      startMonthBtn.style.display = 'none';
      initProgressSection.style.display = 'block';
      
      // Simulate initialization process
      simulateProgress(0, "Checking business...", 1000, () => {
        simulateProgress(30, "Initializing analytics...", 1500, () => {
          simulateProgress(60, "Setting up tracking...", 2000, () => {
            simulateProgress(90, "Finalizing...", 1000, () => {
              progressFill.style.width = '100%';
              progressText.textContent = 'Month initialized successfully!';
              
              // Create month initialization record
              const currentDate = new Date();
              const monthYear = `${currentDate.getMonth() + 1}-${currentDate.getFullYear()}`;
              
              db.collection('analytics').add({
                userId: currentUser.uid,
                month: monthYear,
                initializedAt: firebase.firestore.FieldValue.serverTimestamp(),
                sales: [],
                dailyRecords: {}
              })
              .then(() => {
                setTimeout(() => {
                  monthInitialized = true;
                  monthInitSection.style.display = 'none';
                  dashboardContent.style.display = 'block';
                  loadAnalyticsData();
                }, 1000);
              })
              .catch((error) => {
                console.error("Error initializing month:", error);
                showNotification('Error initializing month. Please try again.', 'error');
                startMonthBtn.style.display = 'block';
                initProgressSection.style.display = 'none';
              });
            });
          });
        });
      });
    }

    // Simulate progress
    function simulateProgress(progress, text, delay, callback) {
      progressFill.style.width = `${progress}%`;
      progressText.textContent = text;
      
      setTimeout(() => {
        if (callback) callback();
      }, delay);
    }

    // Load analytics data
    function loadAnalyticsData() {
      showLoading();
      const timeRange = analyticsData.timeRange;
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - timeRange);
      
      const currentDate = new Date();
      const currentMonthYear = `${currentDate.getMonth() + 1}-${currentDate.getFullYear()}`;
      
      // Load analytics data for current month
      db.collection('analytics')
        .where('userId', '==', currentUser.uid)
        .where('month', '==', currentMonthYear)
        .get()
        .then((querySnapshot) => {
          if (querySnapshot.empty) {
            hideLoading();
            showNotification('No analytics data found for this month', 'info');
            return;
          }
          
          const analyticsDoc = querySnapshot.docs[0].data();
          
          // Load additional data
          Promise.all([
            loadSalesData(startDate),
            loadProductsData(),
            loadLoansData()
          ]).then(() => {
            // Merge with analytics data
            if (analyticsDoc.sales) {
              analyticsData.sales = [...analyticsData.sales, ...analyticsDoc.sales];
            }
            
            processAnalyticsData();
            updateChartNavigation();
            hideLoading();
          }).catch(error => {
            console.error("Error loading analytics data:", error);
            hideLoading();
            showNotification('Error loading analytics data. Please try again.', 'error');
          });
        })
        .catch((error) => {
          console.error("Error loading analytics data:", error);
          hideLoading();
          showNotification('Error loading analytics data. Please try again.', 'error');
        });
    }

    // Load sales data
    function loadSalesData(startDate) {
      return new Promise((resolve, reject) => {
        db.collection('sold')
          .where('userId', '==', currentUser.uid)
          .where('saleDate', '>=', startDate.toISOString().split('T')[0])
          .get()
          .then((querySnapshot) => {
            analyticsData.sales = [];
            querySnapshot.forEach((doc) => {
              analyticsData.sales.push({ id: doc.id, ...doc.data() });
            });
            resolve();
          })
          .catch(reject);
      });
    }

    // Load products data
    function loadProductsData() {
      return new Promise((resolve, reject) => {
        db.collection('stock')
          .where('userId', '==', currentUser.uid)
          .get()
          .then((querySnapshot) => {
            analyticsData.products = [];
            querySnapshot.forEach((doc) => {
              analyticsData.products.push({ id: doc.id, ...doc.data() });
            });
            resolve();
          })
          .catch(reject);
      });
    }

    // Load loans data
    function loadLoansData() {
      return new Promise((resolve, reject) => {
        db.collection('loans')
          .where('userId', '==', currentUser.uid)
          .get()
          .then((querySnapshot) => {
            analyticsData.loans = [];
            querySnapshot.forEach((doc) => {
              analyticsData.loans.push({ id: doc.id, ...doc.data() });
            });
            resolve();
          })
          .catch(reject);
      });
    }

    // Process analytics data and update UI
    function processAnalyticsData() {
      // Calculate key metrics
      const totalRevenue = analyticsData.sales.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
      const totalProductsSold = analyticsData.sales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
      
      // Calculate profit and loss (this would need cost data from products)
      let totalCost = 0;
      analyticsData.sales.forEach(sale => {
        const product = analyticsData.products.find(p => p.id === sale.productId);
        if (product && product.cost) {
          totalCost += product.cost * sale.quantity;
        }
      });
      
      const totalProfit = Math.max(0, totalRevenue - totalCost);
      const totalLoss = Math.max(0, totalCost - totalRevenue);
      
      const unsoldProducts = analyticsData.products.reduce((sum, product) => {
        return sum + (product.quantity || 0);
      }, 0);
      
      const activeLoans = analyticsData.loans.filter(loan => loan.status !== 'paid').length;
      const paidLoans = analyticsData.loans.filter(loan => loan.status === 'paid').length;
      
      // Update summary cards
      totalRevenueElement.textContent = `RWF ${formatNumber(totalRevenue)}`;
      totalProfitElement.textContent = `RWF ${formatNumber(totalProfit)}`;
      totalLossElement.textContent = `RWF ${formatNumber(totalLoss)}`;
      soldProductsElement.textContent = formatNumber(totalProductsSold);
      unsoldProductsElement.textContent = formatNumber(unsoldProducts);
      activeLoansElement.textContent = formatNumber(activeLoans);
      paidLoansElement.textContent = formatNumber(paidLoans);
      
      // Calculate changes (for demonstration, using random values)
      const revenueChange = (Math.random() * 20 - 5).toFixed(1);
      const profitChange = (Math.random() * 25 - 5).toFixed(1);
      const lossChange = (Math.random() * 10 - 3).toFixed(1);
      
      updateChangeIndicator(revenueChangeElement, revenueChange);
      updateChangeIndicator(profitChangeElement, profitChange);
      updateChangeIndicator(lossChangeElement, lossChange);
      
      // Generate charts
      generateRevenueChart();
      
      // Generate AI insights
      generateInsights(totalRevenue, totalProfit, totalLoss, totalProductsSold, unsoldProducts, activeLoans, paidLoans);
      
      // Generate product performance table
      generateProductPerformance();
    }

    // Update change indicator
    function updateChangeIndicator(element, change) {
      const isPositive = parseFloat(change) >= 0;
      element.innerHTML = `${Math.abs(change)}% <i class="fas fa-caret-${isPositive ? 'up' : 'down'}"></i>`;
      element.className = `change ${isPositive ? 'positive' : 'negative'}`;
    }

    // Update chart navigation buttons and display
    function updateChartNavigation() {
      // Enable/disable navigation buttons based on offset
      prevDatesBtn.disabled = chartDataOffset <= 0;
      
      // Update date range display
      const days = analyticsData.timeRange;
      const endDate = new Date();
      endDate.setDate(endDate.getDate() - chartDataOffset);
      
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - (chartDataOffset + days - 1));
      
      dateRangeDisplay.textContent = `Showing ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
    }

    // Generate revenue chart
    function generateRevenueChart() {
      const ctx = document.getElementById('revenueChart');
      if (!ctx) {
        console.error("Canvas element not found");
        return;
      }
      
      // Clear existing chart if it exists
      if (revenueChart) {
        revenueChart.destroy();
      }
      
      // Generate dates based on time range and offset
      const days = analyticsData.timeRange;
      const labels = Array.from({length: days}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (chartDataOffset + days - i - 1));
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      
      // Generate earned and lost data based on actual sales data if available
      let earnedData = [];
      let lostData = [];
      
      if (analyticsData.sales.length > 0) {
        // Group sales by date
        const salesByDate = {};
        
        analyticsData.sales.forEach(sale => {
          const saleDate = new Date(sale.saleDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          if (!salesByDate[saleDate]) {
            salesByDate[saleDate] = { earned: 0, lost: 0 };
          }
          salesByDate[saleDate].earned += sale.totalAmount || 0;
          // For lost data, we'd need cost information which might not be available
        });
        
        // Fill the data arrays
        labels.forEach(label => {
          earnedData.push(salesByDate[label] ? salesByDate[label].earned : 0);
          // For demonstration, using random lost data
          lostData.push(Math.floor(Math.random() * 30000));
        });
      } else {
        // Fallback to random data if no sales data
        earnedData = Array.from({length: days}, () => Math.floor(Math.random() * 100000) + 50000);
        lostData = Array.from({length: days}, () => Math.floor(Math.random() * 30000));
      }
      
      revenueChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Earned',
              data: earnedData,
              backgroundColor: '#4caf50',
              order: 2
            },
            {
              label: 'Lost',
              data: lostData,
              backgroundColor: '#f44336',
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: RWF ${formatNumber(context.raw)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  if (value >= 1000000) return 'RWF ' + (value/1000000).toFixed(1) + 'M';
                  if (value >= 1000) return 'RWF ' + (value/1000).toFixed(0) + 'K';
                  return 'RWF ' + value;
                }
              }
            }
          }
        }
      });
    }

    // Generate AI insights
    function generateInsights(revenue, profit, loss, productsSold, unsoldProducts, activeLoans, paidLoans) {
      insightsContainer.innerHTML = '';
      
      // Check if we have sufficient data
      if (revenue === 0 && productsSold === 0) {
        insightsContainer.innerHTML = `
          <div class="insight-card insight-warning">
            <h4><i class="fas fa-exclamation-triangle"></i> Insufficient Data</h4>
            <p>We need more business data to generate meaningful insights. Continue using Genzura to track sales, products, and loans for personalized recommendations.</p>
          </div>
        `;
        return;
      }
      
      const insights = [];
      
      // Revenue insights
      if (revenue > 500000) {
        insights.push({
          type: 'positive',
          title: 'High Revenue Achievement',
          message: `Your revenue of RWF ${formatNumber(revenue)} is excellent! You're among the top-performing businesses in your category.`
        });
      } else if (revenue > 100000) {
        insights.push({
          type: 'positive',
          title: 'Good Revenue Performance',
          message: `Your revenue of RWF ${formatNumber(revenue)} is solid. Consider expanding your product range to increase earnings.`
        });
      } else {
        insights.push({
          type: 'warning',
          title: 'Revenue Needs Improvement',
          message: `Your revenue of RWF ${formatNumber(revenue)} could be better. Try marketing strategies to attract more customers.`
        });
      }
      
      // Profit/Loss insights
      if (profit > loss) {
        insights.push({
          type: 'positive',
          title: 'Profitable Operation',
          message: `Your business is generating a healthy profit of RWF ${formatNumber(profit)}. Keep up the good work!`
        });
      } else if (loss > profit) {
        insights.push({
          type: 'critical',
          title: 'Loss-Making Operation',
          message: `Your business is currently operating at a loss of RWF ${formatNumber(loss)}. Consider reviewing your costs and pricing.`
        });
      }
      
      // Product insights
      if (unsoldProducts > 50) {
        insights.push({
          type: 'warning',
          title: 'Excess Inventory',
          message: `You have ${unsoldProducts} unsold products. Consider running promotions to clear inventory and free up capital.`
        });
      } else if (unsoldProducts < 10) {
        insights.push({
          type: 'positive',
          title: 'Efficient Inventory Management',
          message: `You have only ${unsoldProducts} unsold products. Your inventory management is efficient!`
        });
      }
      
      if (productsSold > 0) {
        insights.push({
          type: 'positive',
          title: 'Sales Performance',
          message: `You've sold ${productsSold} products. ${productsSold > 50 ? 'Excellent sales volume!' : 'Good start! Try to increase your sales volume.'}`
        });
      }
      
      // Loan insights
      if (activeLoans > 0) {
        insights.push({
          type: 'warning',
          title: 'Active Loans Outstanding',
          message: `You have ${activeLoans} active loans. Ensure timely collection to maintain cash flow.`
        });
      }
      
      if (paidLoans > 0) {
        insights.push({
          type: 'positive',
          title: 'Successful Loan Recovery',
          message: `You've successfully recovered ${paidLoans} loans. Good financial management!`
        });
      }
      
      // Add growth insight
      insights.push({
        type: 'positive',
        title: 'Growth Opportunity',
        message: 'Based on your business pattern, you could increase revenue by 15-20% by expanding your product range in the most popular categories.'
      });
      
      // Display insights
      insights.forEach(insight => {
        const insightElement = document.createElement('div');
        insightElement.className = `insight-card insight-${insight.type}`;
        insightElement.innerHTML = `
          <h4><i class="fas fa-${insight.type === 'positive' ? 'check-circle' : insight.type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i> ${insight.title}</h4>
          <p>${insight.message}</p>
        `;
        insightsContainer.appendChild(insightElement);
      });
    }

    // Generate product performance table
    function generateProductPerformance() {
      // Clear existing content
      productPerformanceBody.innerHTML = '';
      
      // Sample data - in a real app, this would be based on actual product data
      const products = analyticsData.products.slice(0, 5).map(product => {
        const sales = analyticsData.sales.filter(sale => sale.productId === product.id);
        const unitsSold = sales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
        const revenue = sales.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
        const cost = product.cost ? product.cost * unitsSold : 0;
        const profit = revenue - cost;
        const margin = revenue > 0 ? (profit / revenue) * 100 : 0;
        
        return {
          name: product.name,
          unitsSold,
          revenue,
          cost,
          profit,
          margin
        };
      });
      
      if (products.length === 0) {
        productPerformanceBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center;">No product data available yet</td>
          </tr>
        `;
        return;
      }
      
      products.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${product.name}</td>
          <td>${formatNumber(product.unitsSold)}</td>
          <td>RWF ${formatNumber(product.revenue)}</td>
          <td>RWF ${formatNumber(product.cost)}</td>
          <td class="${product.profit >= 0 ? 'profit-positive' : 'profit-negative'}">RWF ${formatNumber(product.profit)}</td>
          <td>${product.margin.toFixed(1)}%</td>
        `;
        productPerformanceBody.appendChild(row);
      });
    }

    // Download all reports
    function downloadAllReports() {
      showNotification('Preparing reports for download...', 'info');
      
      // In a real app, this would generate actual Excel files from the data
      setTimeout(() => {
        const reports = [
          { name: 'Sales_Report', data: analyticsData.sales },
          { name: 'Products_Report', data: analyticsData.products },
          { name: 'Loans_Report', data: analyticsData.loans },
          { name: 'Financial_Summary', data: generateFinancialSummary() }
        ];
        
        reports.forEach(report => {
          // Create worksheet
          const worksheet = XLSX.utils.json_to_sheet(report.data);
          
          // Create workbook
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, report.name);
          
          // Generate Excel file and download
          XLSX.writeFile(workbook, `${report.name}_GENZURA.xlsx`);
        });
        
        showNotification('All reports downloaded successfully!', 'success');
      }, 2000);
    }

    // Generate financial summary data
    function generateFinancialSummary() {
      const totalRevenue = analyticsData.sales.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
      const totalProductsSold = analyticsData.sales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
      
      let totalCost = 0;
      analyticsData.sales.forEach(sale => {
        const product = analyticsData.products.find(p => p.id === sale.productId);
        if (product && product.cost) {
          totalCost += product.cost * sale.quantity;
        }
      });
      
      const totalProfit = totalRevenue - totalCost;
      const activeLoans = analyticsData.loans.filter(loan => loan.status !== 'paid').length;
      const totalLoanAmount = analyticsData.loans
        .filter(loan => loan.status !== 'paid')
        .reduce((sum, loan) => sum + (loan.amount || 0), 0);
      
      return [{
        'Metric': 'Total Revenue',
        'Value': totalRevenue,
        'Currency': 'RWF'
      }, {
        'Metric': 'Total Cost',
        'Value': totalCost,
        'Currency': 'RWF'
      }, {
        'Metric': 'Total Profit',
        'Value': totalProfit,
        'Currency': 'RWF'
      }, {
        'Metric': 'Products Sold',
        'Value': totalProductsSold,
        'Currency': 'Units'
      }, {
        'Metric': 'Active Loans',
        'Value': activeLoans,
        'Currency': 'Count'
      }, {
        'Metric': 'Outstanding Loan Amount',
        'Value': totalLoanAmount,
        'Currency': 'RWF'
      }];
    }

    // Helper function to format numbers
    function formatNumber(num) {
      return new Intl.NumberFormat('en-US').format(Math.round(num));
    }

    // Helper function to get month name
    function getMonthName(monthIndex) {
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                     'July', 'August', 'September', 'October', 'November', 'December'];
      return months[monthIndex];
    }

    // Show loading state
    function showLoading() {
      const chartWrappers = document.querySelectorAll('.chart-wrapper');
      chartWrappers.forEach(wrapper => {
        if (!wrapper.querySelector('.loading-spinner')) {
          wrapper.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
        }
      });
      
      if (insightsContainer && !insightsContainer.querySelector('.loading-spinner')) {
        insightsContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      }
    }

    // Hide loading state
    function hideLoading() {
      const chartWrappers = document.querySelectorAll('.chart-wrapper');
      chartWrappers.forEach(wrapper => {
        wrapper.innerHTML = '<canvas></canvas>';
      });
    }

    // Show notification
    function showNotification(message, type = 'info') {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';
      
      // Hide after 3 seconds
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>
